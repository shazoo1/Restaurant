@model Restaurant.Web.Models.Order.View.OrderViewModel
@{
    ViewBag.Title = "Изменить заказ";
}

<div class="jumbotron">
    <h2>Изменить заказ</h2>
</div>
<div class="row">
    @{Html.RenderPartial("~/Views/Orders/Partial/AmendOrderHeaderPartialView.cshtml", Model.OrderHeader);}
    <div class="col-md-8" style="display:inline">
        <h3 style="text-align:center">Блюда</h3>
        <div class="table" id="dishes">
            <div class="row">
                <h5 class="col-sm">Блюдо</h5>
                <h5 class="col-sm">Количество</h5>
                <h5 class="col-sm">Стоимость</h5>
            </div>
            @foreach (var dish in Model.Dishes)
            {
                Html.RenderPartial("~/Views/Orders/Partial/OrderDishPartialView.cshtml", dish);
            }
        </div>
    </div>
</div>
<div>
    <h5>Доступные действия</h5>
    @if (Model.IsCook)
    {
        using (Html.BeginForm("SetCooked", "Orders", FormMethod.Post))
        {
            <input type="hidden" name="id" value="@Model.OrderHeader.Id" />
            <input type="submit" value="Отметить готовым" />
        }
    }
    else if (Model.IsWaiter)
    {
        if (Model.OrderHeader.OrderState == "ready")
        {
            using (Html.BeginForm("SetServed", "Orders", FormMethod.Post))
            {
                <input type="hidden" name="id" value="@Model.OrderHeader.Id" />
                <input type="submit" value="Отметить поданным" />
            }
            using (Html.BeginForm("SetPaid", "Orders", FormMethod.Post))
            {
                <input type="hidden" name="id" value="@Model.OrderHeader.Id" />
                <input type="submit" value="Отметить оплаченным" />
            }
        }
        if (Model.OrderHeader.OrderState == "served")
        {
            using (Html.BeginForm("SetPaid", "Orders", FormMethod.Post))
            {
                <input type="hidden" name="id" value="@Model.OrderHeader.Id" />
                <input type="submit" value="Отметить оплаченным" />
            }
        }
        if (Model.OrderHeader.OrderState == "accepted")
        {
            <input type="button" value="Добавить блюдо" data-toggle="collapse" data-target="#addDishMenu" />
            <table class="collapse" id="addDishMenu" style="width: 50%">
                <thead>
                    <tr>
                        <th><h6 class="col-sm">Название</h6></th>
                        <th><h6 class="col-sm">Цена</h6></th>
                        <th><h6 class="col-sm-4">Описание</h6></th>
                        <th><h6 class="col-sm">Количество</h6></th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <td><input id="send" type="submit" value="Добавить"/></td>
                    </tr>
                </tfoot>
            </table>
            <script>
                var unselected;
                var selected = [];
                var selectedOrderId = "@Model.OrderHeader.Id.ToString()";
                window.onload = function () {
                unselected = @Html.Raw(Json.Encode(Model.OtherDishes));
                for (var i = 0; i < unselected.length; i++) {
                    var nameCell = '<td>' + unselected[i].Name + '</td>';
                    var priceCell = '<td>' + unselected[i].Price + '</td>';
                    var descCell = '<td>' + unselected[i].Description + '</td>';
                    var counter = '<td><input id="count" type="number"' +
                        ' step="1" min="0" onchange="setDishesCount(this)"/></td>';
                    var row = '<tr id="' + unselected[i].Id + '">'
                        + nameCell + priceCell + descCell + counter + '</tr>';
                    $('#addDishMenu').append(row);
                    }
                    this.document.getElementById('send').addEventListener('click', function () {
                        $.post('@(Url.Action("Change", "Orders"))', {
                            dishes: selected,
                            orderId: selectedOrderId
                        }, function (data) {
                            window.location.href = data;
                        });
                    });
                };
                function setDishesCount(counter) {
                    var count = counter.value * 1;
                    var dishId = counter.closest('tr').id;
                    var orderPart
                    if (count > 0) {
                        
                        if (selected !== undefined) {
                            orderPart = selected.find(x => x.Dish.Id === dishId);
                        }
                        if (orderPart === undefined) {
                            selected.push({
                                'Dish': unselected.find(x => x.Id === dishId),
                                'Quantity': count
                            });
                        }
                        else { orderPart.Quantity = count }
                    } else {
                        if (selected !== undefined) {
                            orderPartindex = selected.findIndex(x =>
                                x.Dish.Id === dishId);
                            selected.splice(orderPartindex, 1);
                        }
                    }
                }
            </script>
        }
    }
    else
    {
        <p>Для этого заказа нет доступных действий.</p>
    }
</div>